<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IIT Tax Calculator â€“ Sri Lanka</title>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
 --bg: #f8fafc;
 --card: rgba(255, 255, 255, 0.8);
 --text: #0f172a;
 --muted: #64748b;
 --primary: #2563eb;
 --accent: #3b82f6;
 --border: #e2e8f0;
 --glass: backdrop-filter: blur(12px);
}

.dark {
 --bg: #020617;
 --card: rgba(30, 41, 59, 0.7);
 --text: #f1f5f9;
 --muted: #94a3b8;
 --primary: #3b82f6;
 --border: #1e293b;
}

body {
    margin: 0;
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    transition: background 0.3s ease;
    background-image: radial-gradient(at 0% 0%, rgba(37, 99, 235, 0.05) 0px, transparent 50%), 
                      radial-gradient(at 100% 100%, rgba(96, 165, 250, 0.05) 0px, transparent 50%);
    min-height: 100vh;
}

.app {
    max-width: 600px;
    margin: auto;
    padding: 24px;
    padding-bottom: 120px;
}

h2 { font-weight: 700; letter-spacing: -0.02em; }

.card {
    background: var(--card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 24px;
    margin-top: 20px;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
}

.label {
    font-size: 13px;
    font-weight: 600;
    color: var(--muted);
    margin-top: 16px;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

input, select {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.05);
    color: var(--text);
    font-size: 16px;
    box-sizing: border-box;
    transition: all 0.2s ease;
}

input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
}

.result {
    background: linear-gradient(135deg, #1e40af, #2563eb);
    color: white;
    border-radius: 24px;
    padding: 24px;
    margin-top: 20px;
    box-shadow: 0 20px 25px -5px rgba(37, 99, 235, 0.2);
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
    margin-top: 20px;
}

.bottomNav {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 500px;
    background: var(--card);
    backdrop-filter: blur(16px);
    border: 1px solid var(--border);
    display: flex;
    justify-content: space-around;
    padding: 12px;
    border-radius: 20px;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    z-index: 100;
}

button {
    background: none;
    border: none;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    color: var(--text);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

.fab {
    position: fixed;
    bottom: 100px;
    right: 30px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 16px;
    padding: 16px 28px;
    font-weight: 700;
    box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
    transition: transform 0.2s;
}

.fab:active { transform: scale(0.95); }

hr { border: 0; border-top: 1px solid var(--border); margin: 20px 0; }

.disclaimer {
    font-size: 11px;
    color: var(--muted);
    line-height: 1.6;
    margin-top: 30px;
}

.copyright-section {
    text-align: center;
    margin-top: 40px;
    padding-bottom: 20px;
    border-top: 1px solid var(--border);
    padding-top: 20px;
}
</style>
</head>

<body>
<div class="app">

<div style="display:flex;justify-content:space-between;align-items:center;">
    <h2 style="margin:0;">TaxWise <span style="color:var(--primary)">SL</span></h2>
    <div style="display:flex; gap:10px;">
        <select id="langSelect" onchange="changeLang()" style="width:auto; padding:5px 10px; font-size:12px;">
            <option value="en">English</option>
            <option value="si">à·ƒà·’à¶‚à·„à¶½</option>
            <option value="ta">à®¤à®®à®¿à®´à¯</option>
        </select>
        <button onclick="toggleDark()" style="font-size: 20px;">ğŸŒ“</button>
    </div>
</div>

<div class="card">
    <div class="label" id="lbl_year">Tax Year</div>
    <select id="year"></select>

    <div class="label" id="lbl_salary">Monthly Salary</div>
    <input id="salary" type="text" inputmode="numeric" placeholder="0" oninput="handleTyping(event)">

    <div class="label" id="lbl_allowance">Monthly Allowances</div>
    <input id="allowance" type="text" inputmode="numeric" placeholder="0" oninput="handleTyping(event)">
 
    <div class="label" id="lbl_bonus">Annual Bonus</div>
    <input id="bonus" type="text" inputmode="numeric" placeholder="0" oninput="handleTyping(event)">

    <div class="label" id="lbl_other">Other Income</div>
    <input id="other" type="text" inputmode="numeric" placeholder="0" oninput="handleTyping(event)">

    <hr>

    <div style="display:flex; justify-content: space-between; align-items: center;">
        <div class="label" id="lbl_epfCheck" style="margin:0">Enable EPF Calculations</div>
        <input type="checkbox" id="epfCheck" style="width: 20px; height: 20px;">
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
            <div class="label" id="lbl_epfRate">Employee EPF %</div>
            <input id="epfRate" type="number" value="8">
        </div>
        <div>
            <div class="label" id="lbl_employerEpf">Employer EPF %</div>
            <input id="employerEpf" type="number" value="12">
        </div>
    </div>

    <div class="label" id="lbl_etfRate">ETF %</div>
    <input id="etfRate" type="number" value="3">

    <hr>

    <div class="label" id="lbl_selfPaid">Self-Assessed Payments</div>
    <input id="selfPaid" type="text" inputmode="numeric" value="0" oninput="handleTyping(event)">

    <div class="label" id="lbl_credits">Tax Credits</div>
    <input id="credits" type="text" inputmode="numeric" value="0" oninput="handleTyping(event)">
</div>

<div id="summaryView"></div>

<div class="card" id="chartCard" style="display:none; padding: 20px;">
    <div class="label" id="lbl_wealth" style="margin-top:0">Wealth Distribution</div>
    <div class="chart-container">
        <canvas id="taxChart"></canvas>
    </div>
</div>

<div id="historyView" style="display:none;">
    <div class="card">
        <div class="label" id="lbl_comparison" style="margin-top:0">Tax Comparison (Last 2 Calculations)</div>
        <div id="comparisonText" style="font-size: 14px; margin-bottom: 15px; font-weight: 500;"></div>
        <div class="chart-container">
            <canvas id="historyChart"></canvas>
        </div>
    </div>
</div>

<div class="disclaimer" id="disclaimer_box">
    <p><strong>Disclaimer:</strong> This tool provides estimates for informational purposes only and does not constitute financial advice. Verify results with the Inland Revenue Department (IRD) of Sri Lanka.</p>
</div>

<div class="copyright-section">
    <p style="font-size: 13px; color: var(--muted); margin: 0;">
        &copy; <script>document.write(new Date().getFullYear())</script> <b>TaxWise SL</b>. All Rights Reserved.
    </p>
    <p style="font-size: 11px; color: var(--muted); opacity: 0.8; margin-top: 5px;">
        TANdplive / TaxWise SL - Version 8.0
    </p>
</div>

<button class="fab" id="btn_calculate" onclick="calculate()">CALCULATE</button>
</div>

<div class="bottomNav">
    <button onclick="openSummary()"><span id="nav_sum_icon">ğŸ“‹</span><span id="nav_sum_text">Summary</span></button>
    <button onclick="openHistory()"><span id="nav_his_icon">ğŸ“Š</span><span id="nav_his_text">Comparison</span></button>
    <button onclick="downloadPDF()"><span id="nav_pdf_icon">â¬‡ï¸</span><span id="nav_pdf_text">PDF</span></button>
    <button onclick="sharePDF()"><span id="nav_sha_icon">ğŸ“¤</span><span id="nav_sha_text">Share</span></button>
</div>

<script>
let lastResult = null;
let chart = null;
let historyChart = null;
let historyData = [];

const i18n = {
    en: {
        year: "Tax Year", salary: "Monthly Salary", allowance: "Monthly Allowances", bonus: "Annual Bonus", other: "Other Income",
        epfCheck: "Enable EPF Calculations", epfRate: "Employee EPF %", employerEpf: "Employer EPF %", etfRate: "ETF %",
        selfPaid: "Self-Assessed Payments", credits: "Tax Credits", wealth: "Wealth Distribution", comparison: "Tax Comparison (Last 2 Calculations)",
        calculate: "CALCULATE", summary: "Summary", history: "Comparison", share: "Share", 
        disclaimer: "<strong>Disclaimer:</strong> This tool provides estimates for informational purposes only and does not constitute financial advice. Verify results with the Inland Revenue Department (IRD) of Sri Lanka.",
        taxYear: "Tax Year", netPayable: "Net Tax Payable (Annual)", income: "Income", taxable: "Taxable", epf: "EPF (8%)", monthly: "Monthly", breakdown: "Breakdown",
        takehome: "Take-home", empEpf: "Employee EPF", emprEpf: "Employer EPF", etf: "ETF", tax: "Tax", 
        compStart: "Perform at least two calculations to see a comparison.", compInc: "Increase", compDec: "Decrease", compOf: "of", compThan: "compared to previous session."
    },
    si: {
        year: "à¶¶à¶¯à·” à·€à¶»à·Šà·‚à¶º", salary: "à¶¸à·à·ƒà·’à¶š à·€à·à¶§à·”à¶´", allowance: "à¶¸à·à·ƒà·’à¶š à¶¯à·“à¶¸à¶±à·", bonus: "à·€à·à¶»à·Šà·‚à·’à¶š à¶´à·Šâ€à¶»à·ƒà·à¶¯ à¶¯à·“à¶¸à¶±à·", other: "à·€à·™à¶±à¶­à·Š à¶†à¶¯à·à¶ºà¶¸à·Š",
        epfCheck: "EPF à¶œà¶«à¶±à¶º à¶šà·’à¶»à·“à¶¸à·Š à·ƒà¶šà·Šâ€à¶»à·“à¶º à¶šà¶»à¶±à·Šà¶±", epfRate: "à·ƒà·šà·€à¶š EPF %", employerEpf: "à·ƒà·šà·€à·Šâ€à¶º EPF %", etfRate: "ETF %",
        selfPaid: "à·ƒà·Šà·€à¶ºà¶‚ à¶­à¶šà·Šà·ƒà·šà¶»à·” à¶œà·™à·€à·“à¶¸à·Š", credits: "à¶¶à¶¯à·” à·ƒà·„à¶±", wealth: "à¶°à¶± à·€à·Šâ€à¶ºà·à¶´à·Šà¶­à·’à¶º", comparison: "à¶¶à¶¯à·” à·ƒà·à·ƒà¶³à·“à¶¸ (à¶…à·€à·ƒà·à¶± à¶œà¶«à¶±à¶º à¶šà·’à¶»à·“à¶¸à·Š 2)",
        calculate: "à¶œà¶«à¶±à¶º à¶šà¶»à¶±à·Šà¶±", summary: "à·ƒà·à¶»à·à¶‚à·à¶º", history: "à·ƒà·à·ƒà¶³à·“à¶¸", share: "à¶¶à·™à¶¯à·à¶œà¶±à·Šà¶±",
        disclaimer: "<strong>à·€à¶œà¶šà·“à¶¸à·Š à¶´à·Šâ€à¶»à¶šà·à·à¶º:</strong> à¶¸à·™à¶¸ à¶¸à·™à·€à¶½à¶¸ à¶­à·œà¶»à¶­à·”à¶»à·” à¶¯à·à¶±à¶œà·à¶±à·“à¶¸ à·ƒà¶³à·„à· à¶´à¶¸à¶«à¶šà·Š à·€à¶± à¶…à¶­à¶» à¶¸à·–à¶½à·Šâ€à¶º à¶‹à¶´à¶¯à·™à·ƒà·Š à¶½à¶¶à· à¶±à·œà¶¯à·š. à·à·Šâ€à¶»à·“ à¶½à¶‚à¶šà· à¶¯à·šà·à·“à¶º à¶†à¶¯à·à¶ºà¶¸à·Š à¶¯à·™à¶´à·à¶»à·Šà¶­à¶¸à·šà¶±à·Šà¶­à·”à·€ (IRD) à·ƒà¶¸à¶Ÿ à¶´à·Šâ€à¶»à¶­à·’à¶µà¶½ à¶­à·„à·€à·”à¶»à·” à¶šà¶»à¶œà¶±à·Šà¶±.",
        taxYear: "à¶¶à¶¯à·” à·€à¶»à·Šà·‚à¶º", netPayable: "à·à·”à¶¯à·Šà¶° à¶¶à¶¯à·” à¶¸à·”à¶¯à¶½ (à·€à·à¶»à·Šà·‚à·’à¶š)", income: "à¶†à¶¯à·à¶ºà¶¸", taxable: "à¶¶à¶¯à·” à¶…à¶º à¶šà·… à·„à·à¶šà·’", epf: "EPF (8%)", monthly: "à¶¸à·à·ƒà·’à¶š", breakdown: "à¶¶à·’à¶³à·€à·à¶§à·“à¶¸",
        takehome: "à¶…à¶­à¶§ à¶½à·à¶¶à·™à¶± à¶¸à·”à¶¯à¶½", empEpf: "à·ƒà·šà·€à¶š EPF", emprEpf: "à·ƒà·šà·€à·Šâ€à¶º EPF", etf: "ETF", tax: "à¶¶à¶¯à·”",
        compStart: "à·ƒà·à·ƒà¶³à·“à¶¸à¶šà·Š à¶¶à·à¶½à·“à¶¸à¶§ à¶…à·€à¶¸ à·€à·à¶ºà·™à¶±à·Š à¶œà¶«à¶±à¶º à¶šà·’à¶»à·“à¶¸à·Š à¶¯à·™à¶šà¶šà·Š à·ƒà·’à¶¯à·” à¶šà¶»à¶±à·Šà¶±.", compInc: "à·€à·à¶©à·’à·€à·“à¶¸", compDec: "à¶…à¶©à·”à·€à·“à¶¸", compOf: "", compThan: "à¶´à·™à¶» à·ƒà·à·ƒà·’à¶ºà¶§ à·ƒà·à¶´à·šà¶šà·Šà·‚à·€."
    },
    ta: {
        year: "à®µà®°à®¿ à®†à®£à¯à®Ÿà¯", salary: "à®®à®¾à®¤à®¾à®¨à¯à®¤à®¿à®° à®šà®®à¯à®ªà®³à®®à¯", allowance: "à®®à®¾à®¤à®¾à®¨à¯à®¤à®¿à®° à®•à¯Šà®Ÿà¯à®ªà¯à®ªà®©à®µà¯à®•à®³à¯", bonus: "à®†à®£à¯à®Ÿà¯ à®ªà¯‹à®©à®¸à¯", other: "à®‡à®¤à®° à®µà®°à¯à®®à®¾à®©à®®à¯",
        epfCheck: "EPF à®•à®£à®•à¯à®•à¯€à®Ÿà¯à®•à®³à¯ˆ à®šà¯†à®¯à®²à¯à®ªà®Ÿà¯à®¤à¯à®¤à®µà¯à®®à¯", epfRate: "à®Šà®´à®¿à®¯à®°à¯ EPF %", employerEpf: "à®®à¯à®¤à®²à®¾à®³à®¿ EPF %", etfRate: "ETF %",
        selfPaid: "à®šà¯à®¯ à®®à®¤à®¿à®ªà¯à®ªà¯€à®Ÿà¯à®Ÿà¯ à®•à¯Šà®Ÿà¯à®ªà¯à®ªà®©à®µà¯à®•à®³à¯", credits: "à®µà®°à®¿ à®µà®°à®µà¯à®•à®³à¯", wealth: "à®šà¯†à®²à¯à®µ à®µà®¿à®¨à®¿à®¯à¯‹à®•à®®à¯", comparison: "à®µà®°à®¿ à®’à®ªà¯à®ªà¯€à®Ÿà¯ (à®•à®Ÿà®¨à¯à®¤ 2 à®•à®£à®•à¯à®•à¯€à®Ÿà¯à®•à®³à¯)",
        calculate: "à®•à®£à®•à¯à®•à®¿à®Ÿà¯à®•", summary: "à®šà¯à®°à¯à®•à¯à®•à®®à¯", history: "à®’à®ªà¯à®ªà¯€à®Ÿà¯", share: "à®ªà®•à®¿à®°à¯",
        disclaimer: "<strong>à®ªà¯Šà®±à¯à®ªà¯à®ªà¯à®¤à¯ à®¤à¯à®±à®ªà¯à®ªà¯:</strong> à®‡à®¨à¯à®¤ à®•à®°à¯à®µà®¿ à®¤à®•à®µà®²à¯ à®¨à¯‹à®•à¯à®•à®™à¯à®•à®³à¯à®•à¯à®•à®¾à®• à®®à®Ÿà¯à®Ÿà¯à®®à¯‡ à®®à®¤à®¿à®ªà¯à®ªà¯€à®Ÿà¯à®•à®³à¯ˆ à®µà®´à®™à¯à®•à¯à®•à®¿à®±à®¤à¯ à®®à®±à¯à®±à¯à®®à¯ à®¨à®¿à®¤à®¿ à®†à®²à¯‹à®šà®©à¯ˆà®¯à®¾à®• à®…à®®à¯ˆà®¯à®¾à®¤à¯. à®®à¯à®Ÿà®¿à®µà¯à®•à®³à¯ˆ à®‡à®²à®™à¯à®•à¯ˆà®¯à®¿à®©à¯ à®‰à®³à¯à®¨à®¾à®Ÿà¯à®Ÿà¯ à®‡à®±à¯ˆà®µà®°à®¿à®¤à¯ à®¤à®¿à®£à¯ˆà®•à¯à®•à®³à®¤à¯à®¤à¯à®Ÿà®©à¯ (IRD) à®šà®°à®¿à®ªà®¾à®°à¯à®•à¯à®•à®µà¯à®®à¯.",
        taxYear: "à®µà®°à®¿ à®†à®£à¯à®Ÿà¯", netPayable: "à®¨à®¿à®•à®° à®µà®°à®¿ à®šà¯†à®²à¯à®¤à¯à®¤ à®µà¯‡à®£à¯à®Ÿà®¿à®¯à®¤à¯ (à®†à®£à¯à®Ÿà¯)", income: "à®µà®°à¯à®®à®¾à®©à®®à¯", taxable: "à®µà®°à®¿à®•à¯à®•à¯à®°à®¿à®¯à®¤à¯", epf: "EPF (8%)", monthly: "à®®à®¾à®¤à®¾à®¨à¯à®¤à®¿à®°", breakdown: "à®ªà®•à¯à®ªà¯à®ªà®¾à®¯à¯à®µà¯",
        takehome: "à®•à¯ˆà®¯à®¿à®²à¯ à®•à®¿à®Ÿà¯ˆà®•à¯à®•à¯à®®à¯ à®¤à¯Šà®•à¯ˆ", empEpf: "à®Šà®´à®¿à®¯à®°à¯ EPF", emprEpf: "à®®à¯à®¤à®²à®¾à®³à®¿ EPF", etf: "ETF", tax: "à®µà®°à®¿",
        compStart: "à®’à®ªà¯à®ªà¯€à®Ÿà¯à®Ÿà¯ˆà®ªà¯ à®ªà®¾à®°à¯à®•à¯à®• à®•à¯à®±à¯ˆà®¨à¯à®¤à®¤à¯ à®‡à®°à®£à¯à®Ÿà¯ à®•à®£à®•à¯à®•à¯€à®Ÿà¯à®•à®³à¯ˆà®šà¯ à®šà¯†à®¯à¯à®¯à®µà¯à®®à¯.", compInc: "à®…à®¤à®¿à®•à®°à®¿à®ªà¯à®ªà¯", compDec: "à®•à¯à®±à¯ˆà®µà¯", compOf: "", compThan: "à®®à¯à®¨à¯à®¤à¯ˆà®¯ à®…à®®à®°à¯à®µà¯à®Ÿà®©à¯ à®’à®ªà¯à®ªà®¿à®Ÿà¯à®®à¯à®ªà¯‹à®¤à¯."
    }
};

function changeLang() {
    const l = i18n[document.getElementById('langSelect').value];
    document.getElementById('lbl_year').innerText = l.year;
    document.getElementById('lbl_salary').innerText = l.salary;
    document.getElementById('lbl_allowance').innerText = l.allowance;
    document.getElementById('lbl_bonus').innerText = l.bonus;
    document.getElementById('lbl_other').innerText = l.other;
    document.getElementById('lbl_epfCheck').innerText = l.epfCheck;
    document.getElementById('lbl_epfRate').innerText = l.epfRate;
    document.getElementById('lbl_employerEpf').innerText = l.employerEpf;
    document.getElementById('lbl_etfRate').innerText = l.etfRate;
    document.getElementById('lbl_selfPaid').innerText = l.selfPaid;
    document.getElementById('lbl_credits').innerText = l.credits;
    document.getElementById('lbl_wealth').innerText = l.wealth;
    document.getElementById('lbl_comparison').innerText = l.comparison;
    document.getElementById('btn_calculate').innerText = l.calculate;
    document.getElementById('nav_sum_text').innerText = l.summary;
    document.getElementById('nav_his_text').innerText = l.history;
    document.getElementById('nav_sha_text').innerText = l.share;
    document.getElementById('disclaimer_box').innerHTML = `<p>${l.disclaimer}</p>`;
    if(lastResult) renderSummary(lastResult);
    if(document.getElementById('historyView').style.display === "block") openHistory();
}

function handleTyping(e) {
    let value = e.target.value.replace(/,/g, '');
    if (!isNaN(value) && value !== "") {
        e.target.value = Number(value).toLocaleString('en-US');
    }
}

function getCurrentTaxYear(){
    const now = new Date();
    let y = now.getFullYear();
    let m = now.getMonth() + 1;
    return (m < 4) ? (y - 1) + "/" + String(y).slice(2) : y + "/" + String(y + 1).slice(2);
}

function populateYears(){
    const current = getCurrentTaxYear();
    const yearEl = document.getElementById('year');
    yearEl.innerHTML = `
        <option>2023/24</option>
        <option>2024/25</option>
        <option selected>${current} (Current Year)</option>
    `;
}

window.onload = () => {
    populateYears();
    document.getElementById('epfCheck').checked = false; // Unticked by default
    if(localStorage.getItem("darkMode") === "on") document.body.classList.add("dark");
};

function toggleDark(){
    document.body.classList.toggle("dark");
    localStorage.setItem("darkMode", document.body.classList.contains("dark") ? "on" : "off");
}

function parseNum(id){ 
    let val = document.getElementById(id).value.replace(/,/g, '');
    return Number(val) || 0; 
}

function lkr(v){ return "LKR " + Number(v).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); }

function getTaxRules(year){
    if(year === "2023/24" || year === "2024/25"){
        return { relief: 1200000, slabs: [500000, 500000, 500000, 500000, 500000], rates: [0.06, 0.12, 0.18, 0.24, 0.30], topRate: 0.36 };
    }
    return { relief: 1800000, slabs: [1000000, 500000, 500000, 500000], rates: [0.06, 0.18, 0.24, 0.30], topRate: 0.36 };
}

function calculate(){
    const selectedYear = document.getElementById('year').value.replace(" (Current Year)", "");
    const salary = parseNum("salary");
    const allowance = parseNum("allowance");
    const bonus = parseNum("bonus");
    const other = parseNum("other");
    const selfPaid = parseNum("selfPaid");
    const credits = parseNum("credits");

    const annualSalary = salary * 12;
    const annualIncome = annualSalary + (allowance * 12) + bonus + other;

    let epfDeduction = 0;
    let employerEPF = 0;
    let etf = 0;

    if(document.getElementById('epfCheck').checked){
        epfDeduction = annualSalary * (parseNum("epfRate") / 100);
        employerEPF = annualSalary * (parseNum("employerEpf") / 100);
        etf = annualSalary * (parseNum("etfRate") / 100);
    }

    const rules = getTaxRules(selectedYear);
    const taxableIncome = Math.max(0, annualIncome - epfDeduction - rules.relief);

    let rem = taxableIncome;
    let tax = 0;
    let breakdown = [];

    for(let i = 0; i < rules.slabs.length && rem > 0; i++){
        let amt = Math.min(rem, rules.slabs[i]);
        let bandTax = amt * rules.rates[i];
        tax += bandTax;
        breakdown.push(`Band ${i+1} (${(rules.rates[i]*100).toFixed(0)}%): ${lkr(bandTax)}`);
        rem -= amt;
    }

    if(rem > 0){
        let extra = rem * rules.topRate;
        tax += extra;
        breakdown.push(`Balance (${(rules.topRate*100).toFixed(0)}%): ${lkr(extra)}`);
    }

    const netTax = Math.max(0, tax - selfPaid - credits);
    
    lastResult = {
        year: selectedYear,
        annualIncome, epfDeduction, taxableIncome,
        grossTax: tax, netTax, monthlyTax: netTax / 12,
        employerEPF, etf,
        selfPaid, credits, breakdown,
        timestamp: new Date().toLocaleTimeString()
    };

    historyData.push(lastResult);
    if(historyData.length > 5) historyData.shift();

    openSummary();
    renderSummary(lastResult);
    document.getElementById('chartCard').style.display = 'block';
    drawChart(annualIncome, epfDeduction, netTax, employerEPF, etf);
    
    window.scrollTo({ top: document.getElementById('summaryView').offsetTop - 20, behavior: 'smooth' });
}

function renderSummary(r){
    const l = i18n[document.getElementById('langSelect').value];
    document.getElementById('summaryView').innerHTML = `
    <div class="result">
        <div style="font-size:12px; opacity:0.8; margin-bottom:4px">${l.taxYear}: ${r.year}</div>
        <h1 style="margin:0; font-size:32px">${lkr(r.netTax)}</h1>
        <div style="font-size:14px; opacity:0.9; margin-bottom:16px">${l.netPayable}</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:12px; border-top:1px solid rgba(255,255,255,0.2); padding-top:15px;">
            <div>${l.income}: <b>${lkr(r.annualIncome)}</b></div>
            <div>${l.taxable}: <b>${lkr(r.taxableIncome)}</b></div>
            <div>${l.epf}: <b>${lkr(r.epfDeduction)}</b></div>
            <div>${l.monthly}: <b>${lkr(r.monthlyTax)}</b></div>
        </div>
        <div style="margin-top:15px; font-size:11px; background:rgba(0,0,0,0.1); padding:10px; border-radius:10px;">
            <b>${l.breakdown}:</b><br>${r.breakdown.join("<br>")}
        </div>
    </div>`;
}

function drawChart(income, epf, tax, employerEPF, etf){
    const l = i18n[document.getElementById('langSelect').value];
    const ctx = document.getElementById('taxChart').getContext('2d');
    if(chart) chart.destroy();
    const takeHome = Math.max(0, income - epf - tax);
    chart = new Chart(ctx, {
        type: "doughnut",
        data: {
            labels: [l.takehome, l.empEpf, l.emprEpf, l.etf, l.tax],
            datasets: [{
                data: [takeHome, epf, employerEPF, etf, tax],
                backgroundColor: ["#10b981", "#3b82f6", "#8b5cf6", "#f59e0b", "#ef4444"],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: getComputedStyle(document.body).getPropertyValue('--text'), font: { family: 'Plus Jakarta Sans' } } }
            },
            cutout: '70%'
        }
    });
}

function openHistory(){ 
    const l = i18n[document.getElementById('langSelect').value];
    document.getElementById('summaryView').style.display = "none";
    document.getElementById('chartCard').style.display = "none";
    document.getElementById('historyView').style.display = "block";

    if(historyData.length < 2) {
        document.getElementById('comparisonText').innerHTML = l.compStart;
        return;
    }

    const latest = historyData[historyData.length - 1];
    const previous = historyData[historyData.length - 2];
    
    const diff = latest.netTax - previous.netTax;
    const percent = previous.netTax !== 0 ? ((diff / previous.netTax) * 100).toFixed(1) : (latest.netTax > 0 ? 100 : 0);
    const color = diff > 0 ? "#ef4444" : "#10b981";
    const status = diff > 0 ? l.compInc : l.compDec;

    document.getElementById('comparisonText').innerHTML = `
        <span style="color:${color}; font-weight:700;">${status} ${l.compOf} ${Math.abs(percent)}%</span> 
        (${lkr(Math.abs(diff))}) ${l.compThan}
    `;

    const hCtx = document.getElementById('historyChart').getContext('2d');
    if(historyChart) historyChart.destroy();

    historyChart = new Chart(hCtx, {
        type: 'bar',
        data: {
            labels: [`Prev (${previous.year})`, `Current (${latest.year})`],
            datasets: [{
                label: 'Net Tax (LKR)',
                data: [previous.netTax, latest.netTax],
                backgroundColor: ['#94a3b8', '#2563eb'],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }
            }
        }
    });
}

function openSummary(){ 
    document.getElementById('historyView').style.display = "none";
    document.getElementById('summaryView').style.display = "block";
    document.getElementById('chartCard').style.display = lastResult ? "block" : "none";
}

function generatePDF() {
    if (!lastResult) return null;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFillColor(37, 99, 235); 
    doc.rect(0, 0, 210, 40, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(26);
    doc.text("TaxWise", 14, 22);
    doc.setFont("helvetica", "normal");
    doc.text("SL", 56, 22);
    doc.setFontSize(10);
    doc.text("Individual Income Tax Assessment Report", 14, 32);
    doc.text(new Date().toLocaleDateString(), 170, 32);

    let y = 55;
    doc.setTextColor(15, 23, 42); 
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("Financial Summary", 14, y);
    y += 8;

    const drawRow = (label, value, isBold = false) => {
        doc.setFont("helvetica", isBold ? "bold" : "normal");
        doc.setDrawColor(226, 232, 240); 
        doc.line(14, y - 5, 196, y - 5);
        doc.text(label, 16, y);
        doc.text(value, 194, y, { align: "right" });
        y += 10;
    };

    drawRow("Assessment Year", lastResult.year);
    drawRow("Gross Annual Income", lkr(lastResult.annualIncome));
    drawRow("Employee EPF Contribution", "(" + lkr(lastResult.epfDeduction) + ")");
    drawRow("Self-Paid / Credits", "(" + lkr(lastResult.selfPaid + lastResult.credits) + ")");
    drawRow("Taxable Income", lkr(lastResult.taxableIncome), true);

    y += 5;
    doc.setFont("helvetica", "bold");
    doc.text("Tax Calculation Breakdown", 14, y);
    y += 8;
    lastResult.breakdown.forEach(item => {
        const parts = item.split(": ");
        drawRow(parts[0], parts[1]);
    });

    if (document.getElementById('epfCheck').checked) {
        y += 5;
        doc.setFont("helvetica", "bold");
        doc.text("Employer Contributions (Statutory)", 14, y);
        y += 8;
        drawRow("Employer EPF (12%)", lkr(lastResult.employerEPF));
        drawRow("ETF (3%)", lkr(lastResult.etf));
    }

    y += 5;
    doc.setFillColor(248, 250, 252);
    doc.rect(14, y, 182, 28, 'F');
    doc.setDrawColor(37, 99, 235);
    doc.setLineWidth(0.5);
    doc.rect(14, y, 182, 28, 'D');
    
    doc.setTextColor(37, 99, 235);
    doc.setFontSize(9);
    doc.text("TOTAL ANNUAL TAX PAYABLE", 20, y + 10);
    doc.setFontSize(18);
    doc.text(lkr(lastResult.netTax), 20, y + 20);
    
    doc.setTextColor(100, 116, 139);
    doc.setFontSize(9);
    doc.text("Monthly Installment", 140, y + 10);
    doc.setFontSize(12);
    doc.text(lkr(lastResult.monthlyTax), 140, y + 20);

    doc.saveGraphicsState();
    doc.setGState(new doc.GState({opacity: 0.1}));
    doc.setFontSize(40);
    doc.setTextColor(150);
    doc.text("VERIFIED BY TAXWISE SL", 40, 150, {angle: 45});
    doc.restoreGraphicsState();

    return doc.output("blob");
}

function downloadPDF(){
    if(!lastResult){ alert("Please calculate first"); return; }
    let blob = generatePDF();
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `Tax_Report_${lastResult.year}.pdf`;
    a.click();
}

async function sharePDF(){
    if(!lastResult){ alert("Please calculate first"); return; }
    let blob = generatePDF();
    let file = new File([blob], "TaxReport.pdf", {type: "application/pdf"});
    if(navigator.canShare && navigator.canShare({files: [file]})){
        await navigator.share({files: [file], title: "My Tax Report"});
    } else {
        window.open(URL.createObjectURL(blob));
    }
}
</script>
</body>
</html>

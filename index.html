<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IIT Tax Calculator ‚Äì Sri Lanka</title>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
 --bg: #f8fafc;
 --card: rgba(255, 255, 255, 0.8);
 --text: #0f172a;
 --muted: #64748b;
 --primary: #2563eb;
 --accent: #3b82f6;
 --border: #e2e8f0;
 --glass: backdrop-filter: blur(12px);
}

.dark {
 --bg: #020617;
 --card: rgba(30, 41, 59, 0.7);
 --text: #f1f5f9;
 --muted: #94a3b8;
 --primary: #3b82f6;
 --border: #1e293b;
}

body {
    margin: 0;
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    transition: background 0.3s ease;
    background-image: radial-gradient(at 0% 0%, rgba(37, 99, 235, 0.05) 0px, transparent 50%), 
                      radial-gradient(at 100% 100%, rgba(96, 165, 250, 0.05) 0px, transparent 50%);
    min-height: 100vh;
}

.app {
    max-width: 600px;
    margin: auto;
    padding: 24px;
    padding-bottom: 120px;
}

h2 { font-weight: 700; letter-spacing: -0.02em; }

.card {
    background: var(--card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 24px;
    margin-top: 20px;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
}

.label {
    font-size: 13px;
    font-weight: 600;
    color: var(--muted);
    margin-top: 16px;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

input, select {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.05);
    color: var(--text);
    font-size: 16px;
    box-sizing: border-box;
    transition: all 0.2s ease;
}

input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
}

.result {
    background: linear-gradient(135deg, #1e40af, #2563eb);
    color: white;
    border-radius: 24px;
    padding: 24px;
    margin-top: 20px;
    box-shadow: 0 20px 25px -5px rgba(37, 99, 235, 0.2);
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
    margin-top: 20px;
}

.bottomNav {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 500px;
    background: var(--card);
    backdrop-filter: blur(16px);
    border: 1px solid var(--border);
    display: flex;
    justify-content: space-around;
    padding: 12px;
    border-radius: 20px;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    z-index: 100;
}

button {
    background: none;
    border: none;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    color: var(--text);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

.fab {
    position: fixed;
    bottom: 100px;
    right: 30px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 16px;
    padding: 16px 28px;
    font-weight: 700;
    box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
    transition: transform 0.2s;
}

.fab:active { transform: scale(0.95); }

hr { border: 0; border-top: 1px solid var(--border); margin: 20px 0; }

.disclaimer {
    font-size: 11px;
    color: var(--muted);
    line-height: 1.6;
    margin-top: 30px;
    padding-bottom: 40px;
}
</style>
</head>

<body>
<div class="app">

<div style="display:flex;justify-content:space-between;align-items:center;">
    <h2 style="margin:0;">TaxWise <span style="color:var(--primary)">SL</span></h2>
    <button onclick="toggleDark()" style="font-size: 20px;">üåì</button>
</div>

<div class="card">
    <div class="label">Tax Year</div>
    <select id="year"></select>

    <div class="label">Monthly Salary</div>
    <input id="salary" type="number" placeholder="0">

    <div class="label">Monthly Allowances</div>
    <input id="allowance" type="number" placeholder="0">

    <div class="label">Annual Bonus</div>
    <input id="bonus" type="number" placeholder="0">

    <div class="label">Other Income</div>
    <input id="other" type="number" placeholder="0">

    <hr>

    <div style="display:flex; justify-content: space-between; align-items: center;">
        <div class="label" style="margin:0">Enable EPF Calculations</div>
        <input type="checkbox" id="epfCheck" checked style="width: 20px; height: 20px;">
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
            <div class="label">Employee EPF %</div>
            <input id="epfRate" type="number" value="8">
        </div>
        <div>
            <div class="label">Employer EPF %</div>
            <input id="employerEpf" type="number" value="12">
        </div>
    </div>

    <div class="label">ETF %</div>
    <input id="etfRate" type="number" value="3">

    <hr>

    <div class="label">Self-Assessed Payments</div>
    <input id="selfPaid" type="number" value="0">

    <div class="label">Tax Credits</div>
    <input id="credits" type="number" value="0">
</div>

<div id="summaryView"></div>

<div class="card" id="chartCard" style="display:none; padding: 20px;">
    <div class="label" style="margin-top:0">Wealth Distribution</div>
    <div class="chart-container">
        <canvas id="taxChart"></canvas>
    </div>
</div>

<div id="historyView" style="display:none;">
    <div class="card">
        <div class="label" style="margin-top:0">Tax Comparison (Last 2 Calculations)</div>
        <div id="comparisonText" style="font-size: 14px; margin-bottom: 15px; font-weight: 500;"></div>
        <div class="chart-container">
            <canvas id="historyChart"></canvas>
        </div>
    </div>
</div>

<div class="disclaimer">
    <p><strong>Disclaimer:</strong> This tool provides estimates for informational purposes only and does not constitute financial advice. Verify results with the Inland Revenue Department (IRD) of Sri Lanka.</p>
</div>

<button class="fab" onclick="calculate()">CALCULATE</button>
</div>

<div class="bottomNav">
    <button onclick="openSummary()"><span>üìã</span>Summary</button>
    <button onclick="openHistory()"><span>üìä</span>History</button>
    <button onclick="downloadPDF()"><span>‚¨áÔ∏è</span>PDF</button>
    <button onclick="sharePDF()"><span>üì§</span>Share</button>
</div>

<script>
let lastResult = null;
let chart = null;
let historyChart = null;
let historyData = [];

function getCurrentTaxYear(){
    const now = new Date();
    let y = now.getFullYear();
    let m = now.getMonth() + 1;
    return (m < 4) ? (y - 1) + "/" + String(y).slice(2) : y + "/" + String(y + 1).slice(2);
}

function populateYears(){
    const current = getCurrentTaxYear();
    const yearEl = document.getElementById('year');
    yearEl.innerHTML = `
        <option>2023/24</option>
        <option>2024/25</option>
        <option selected>${current} (Current Year)</option>
    `;
}

window.onload = () => {
    populateYears();
    if(localStorage.getItem("darkMode") === "on") document.body.classList.add("dark");
};

function toggleDark(){
    document.body.classList.toggle("dark");
    localStorage.setItem("darkMode", document.body.classList.contains("dark") ? "on" : "off");
}

function parseNum(id){ return Number(document.getElementById(id).value) || 0; }
function lkr(v){ return "LKR " + Number(v).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); }

function getTaxRules(year){
    if(year === "2023/24" || year === "2024/25"){
        return { relief: 1200000, slabs: [500000, 500000, 500000, 500000, 500000], rates: [0.06, 0.12, 0.18, 0.24, 0.30], topRate: 0.36 };
    }
    return { relief: 1800000, slabs: [1000000, 500000, 500000, 500000], rates: [0.06, 0.18, 0.24, 0.30], topRate: 0.36 };
}

function calculate(){
    const selectedYear = document.getElementById('year').value.replace(" (Current Year)", "");
    const salary = parseNum("salary");
    const allowance = parseNum("allowance");
    const bonus = parseNum("bonus");
    const other = parseNum("other");
    const selfPaid = parseNum("selfPaid");
    const credits = parseNum("credits");

    const annualSalary = salary * 12;
    const annualIncome = annualSalary + (allowance * 12) + bonus + other;

    let epfDeduction = 0;
    let employerEPF = 0;
    let etf = 0;

    if(document.getElementById('epfCheck').checked){
        epfDeduction = annualSalary * (parseNum("epfRate") / 100);
        employerEPF = annualSalary * (parseNum("employerEpf") / 100);
        etf = annualSalary * (parseNum("etfRate") / 100);
    }

    const rules = getTaxRules(selectedYear);
    const taxableIncome = Math.max(0, annualIncome - epfDeduction - rules.relief);

    let rem = taxableIncome;
    let tax = 0;
    let breakdown = [];

    for(let i = 0; i < rules.slabs.length && rem > 0; i++){
        let amt = Math.min(rem, rules.slabs[i]);
        let bandTax = amt * rules.rates[i];
        tax += bandTax;
        breakdown.push(`Band ${i+1} (${(rules.rates[i]*100).toFixed(0)}%): ${lkr(bandTax)}`);
        rem -= amt;
    }

    if(rem > 0){
        let extra = rem * rules.topRate;
        tax += extra;
        breakdown.push(`Balance (${(rules.topRate*100).toFixed(0)}%): ${lkr(extra)}`);
    }

    const netTax = Math.max(0, tax - selfPaid - credits);
    
    lastResult = {
        year: selectedYear,
        annualIncome, epfDeduction, taxableIncome,
        grossTax: tax, netTax, monthlyTax: netTax / 12,
        employerEPF, etf,
        selfPaid, credits, breakdown,
        timestamp: new Date().toLocaleTimeString()
    };

    // Save to history list
    historyData.push(lastResult);
    if(historyData.length > 5) historyData.shift();

    renderSummary(lastResult);
    document.getElementById('chartCard').style.display = 'block';
    drawChart(annualIncome, epfDeduction, netTax, employerEPF, etf);
    
    window.scrollTo({ top: document.getElementById('summaryView').offsetTop - 20, behavior: 'smooth' });
}

function renderSummary(r){
    document.getElementById('summaryView').innerHTML = `
    <div class="result">
        <div style="font-size:12px; opacity:0.8; margin-bottom:4px">Tax Year: ${r.year}</div>
        <h1 style="margin:0; font-size:32px">${lkr(r.netTax)}</h1>
        <div style="font-size:14px; opacity:0.9; margin-bottom:16px">Net Tax Payable (Annual)</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:12px; border-top:1px solid rgba(255,255,255,0.2); padding-top:15px;">
            <div>Income: <b>${lkr(r.annualIncome)}</b></div>
            <div>Taxable: <b>${lkr(r.taxableIncome)}</b></div>
            <div>EPF (8%): <b>${lkr(r.epfDeduction)}</b></div>
            <div>Monthly: <b>${lkr(r.monthlyTax)}</b></div>
        </div>
        <div style="margin-top:15px; font-size:11px; background:rgba(0,0,0,0.1); padding:10px; border-radius:10px;">
            <b>Breakdown:</b><br>${r.breakdown.join("<br>")}
        </div>
    </div>`;
}

function drawChart(income, epf, tax, employerEPF, etf){
    const ctx = document.getElementById('taxChart').getContext('2d');
    if(chart) chart.destroy();
    const takeHome = Math.max(0, income - epf - tax);
    chart = new Chart(ctx, {
        type: "doughnut",
        data: {
            labels: ["Take-home", "Employee EPF", "Employer EPF", "ETF", "Tax"],
            datasets: [{
                data: [takeHome, epf, employerEPF, etf, tax],
                backgroundColor: ["#10b981", "#3b82f6", "#8b5cf6", "#f59e0b", "#ef4444"],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: getComputedStyle(document.body).getPropertyValue('--text'), font: { family: 'Plus Jakarta Sans' } } }
            },
            cutout: '70%'
        }
    });
}

// Adjusted: Logic for History Bar Chart Comparison
function openHistory(){ 
    document.getElementById('summaryView').style.display = "none";
    document.getElementById('chartCard').style.display = "none";
    document.getElementById('historyView').style.display = "block";

    if(historyData.length < 2) {
        document.getElementById('comparisonText').innerHTML = "Perform at least two calculations to see a comparison.";
        return;
    }

    const latest = historyData[historyData.length - 1];
    const previous = historyData[historyData.length - 2];
    
    // Comparison calculation
    const diff = latest.netTax - previous.netTax;
    const percent = previous.netTax !== 0 ? ((diff / previous.netTax) * 100).toFixed(1) : (latest.netTax > 0 ? 100 : 0);
    const color = diff > 0 ? "#ef4444" : "#10b981";
    const status = diff > 0 ? "Increase" : "Decrease";

    document.getElementById('comparisonText').innerHTML = `
        <span style="color:${color}; font-weight:700;">${status} of ${Math.abs(percent)}%</span> 
        (${lkr(Math.abs(diff))}) compared to previous session.
    `;

    const hCtx = document.getElementById('historyChart').getContext('2d');
    if(historyChart) historyChart.destroy();

    historyChart = new Chart(hCtx, {
        type: 'bar',
        data: {
            labels: [`Prev (${previous.year})`, `Current (${latest.year})`],
            datasets: [{
                label: 'Net Tax (LKR)',
                data: [previous.netTax, latest.netTax],
                backgroundColor: ['#94a3b8', '#2563eb'],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }
            }
        }
    });
}

function openSummary(){ 
    document.getElementById('historyView').style.display = "none";
    document.getElementById('summaryView').style.display = "block";
    document.getElementById('chartCard').style.display = lastResult ? "block" : "none";
}

function generatePDF(){
    if(!lastResult) return null;
    const {jsPDF} = window.jspdf;
    const doc = new jsPDF();
    doc.setFont("helvetica", "bold");
    doc.text("IIT Tax Report ‚Äì Sri Lanka", 14, 20);
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    
    let y = 35;
    const rows = [
        ["Tax Year", lastResult.year],
        ["Annual Income", lkr(lastResult.annualIncome)],
        ["EPF Deduction", lkr(lastResult.epfDeduction)],
        ["Taxable Income", lkr(lastResult.taxableIncome)],
        ["Gross Tax", lkr(lastResult.grossTax)],
        ["Net Tax Payable", lkr(lastResult.netTax)]
    ];

    rows.forEach(r => {
        doc.text(r[0], 14, y);
        doc.text(r[1], 100, y);
        y += 10;
    });
    return doc.output("blob");
}

function downloadPDF(){
    if(!lastResult){ alert("Please calculate first"); return; }
    let blob = generatePDF();
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `Tax_Report_${lastResult.year}.pdf`;
    a.click();
}

async function sharePDF(){
    if(!lastResult){ alert("Please calculate first"); return; }
    let blob = generatePDF();
    let file = new File([blob], "TaxReport.pdf", {type: "application/pdf"});
    if(navigator.canShare && navigator.canShare({files: [file]})){
        await navigator.share({files: [file], title: "My Tax Report"});
    } else {
        window.open(URL.createObjectURL(blob));
    }
}
</script>
</body>
</html>

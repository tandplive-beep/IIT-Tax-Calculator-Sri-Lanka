    <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IIT Tax Calculator тАУ Sri Lanka</title>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
 --bg: #f8fafc;
 --card: rgba(255, 255, 255, 0.8);
 --text: #0f172a;
 --muted: #64748b;
 --primary: #2563eb;
 --accent: #3b82f6;
 --border: #e2e8f0;
 --glass: backdrop-filter: blur(12px);
}

.dark {
 --bg: #020617;
 --card: rgba(30, 41, 59, 0.7);
 --text: #f1f5f9;
 --muted: #94a3b8;
 --primary: #3b82f6;
 --border: #1e293b;
}

body {
    margin: 0;
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    transition: background 0.3s ease;
    background-image: radial-gradient(at 0% 0%, rgba(37, 99, 235, 0.05) 0px, transparent 50%), 
                      radial-gradient(at 100% 100%, rgba(96, 165, 250, 0.05) 0px, transparent 50%);
    min-height: 100vh;
}

.app {
    max-width: 600px;
    margin: auto;
    padding: 24px;
    padding-bottom: 120px;
}

h2 { font-weight: 700; letter-spacing: -0.02em; }

.card {
    background: var(--card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 24px;
    margin-top: 20px;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
}

.label {
    font-size: 13px;
    font-weight: 600;
    color: var(--muted);
    margin-top: 16px;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

input, select {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.05);
    color: var(--text);
    font-size: 16px;
    box-sizing: border-box;
    transition: all 0.2s ease;
}

input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
}

.result {
    background: linear-gradient(135deg, #1e40af, #2563eb);
    color: white;
    border-radius: 24px;
    padding: 24px;
    margin-top: 20px;
    box-shadow: 0 20px 25px -5px rgba(37, 99, 235, 0.2);
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
    margin-top: 20px;
}

.bottomNav {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 500px;
    background: var(--card);
    backdrop-filter: blur(16px);
    border: 1px solid var(--border);
    display: flex;
    justify-content: space-around;
    padding: 12px;
    border-radius: 20px;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    z-index: 100;
}

button {
    background: none;
    border: none;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    color: var(--text);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

.fab {
    position: fixed;
    bottom: 100px;
    right: 30px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 16px;
    padding: 16px 28px;
    font-weight: 700;
    box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
    transition: transform 0.2s;
}

.fab:active { transform: scale(0.95); }

hr { border: 0; border-top: 1px solid var(--border); margin: 20px 0; }

.disclaimer {
    font-size: 11px;
    color: var(--muted);
    line-height: 1.6;
    margin-top: 30px;
}

.copyright-section {
    text-align: center;
    margin-top: 40px;
    padding-bottom: 20px;
    border-top: 1px solid var(--border);
    padding-top: 20px;
}
</style>
</head>

<body>
<div class="app">

<div style="display:flex;justify-content:space-between;align-items:flex-start;">
    <div>
        <img src="https://raw.githubusercontent.com/tandplive-beep/IIT-Tax-Calculator-Sri-Lanka/refs/heads/main/file_0000000081ac71fa9f5e59de4c9df360%20(1).png" alt="TaxWise SL Logo" style="height: 60px; width: auto; display: block;">
        <span style="font-size: 12px; color: var(--muted); font-weight: 500; margin-left: 2px;">Your Taxes, Simplified.</span>
    </div>
    <div style="display:flex; gap:10px; margin-top: 5px;">
        <select id="langSelect" onchange="changeLang()" style="width:auto; padding:5px 10px; font-size:12px;">
            <option value="en">English</option>
            <option value="si">р╖Гр╖Тр╢Вр╖Др╢╜</option>
            <option value="ta">родрооро┐ро┤рпН</option>
        </select>
        <button onclick="toggleDark()" style="font-size: 20px;">ЁЯМУ</button>
    </div>
</div>

<div class="card">
    <div class="label" id="lbl_year">Tax Year</div>
    <select id="year"></select>

    <div class="label" id="lbl_salary">Monthly Salary</div>
    <input id="salary" type="text" inputmode="numeric" placeholder="0" oninput="handleTyping(event)">

    <div class="label" id="lbl_allowance">Monthly Allowances</div>
    <input id="allowance" type="text" inputmode="numeric" placeholder="0" oninput="handleTyping(event)">
 
    <div class="label" id="lbl_other">Other Income (Annual)</div>
    <input id="other" type="text" inputmode="numeric" placeholder="0" oninput="handleTyping(event)">

    <hr>

    <div class="label" id="lbl_selfPaid">Self-Assessed Payments</div>
    <input id="selfPaid" type="text" inputmode="numeric" value="0" oninput="handleTyping(event)">

    <div class="label" id="lbl_credits">Tax Credits</div>
    <input id="credits" type="text" inputmode="numeric" value="0" oninput="handleTyping(event)">
</div>

<div id="summaryView"></div>

<div class="card" id="chartCard" style="display:none; padding: 20px;">
    <div class="label" id="lbl_wealth" style="margin-top:0">Income vs Tax Distribution</div>
    <div class="chart-container">
        <canvas id="taxChart"></canvas>
    </div>
</div>

<div id="historyView" style="display:none;">
    <div class="card">
        <div class="label" id="lbl_comparison" style="margin-top:0">Tax Comparison (Last 2 Calculations)</div>
        <div id="comparisonText" style="font-size: 14px; margin-bottom: 15px; font-weight: 500;"></div>
        <div class="chart-container">
            <canvas id="historyChart"></canvas>
        </div>
    </div>
</div>

<div class="disclaimer" id="disclaimer_box">
    <p><strong>Disclaimer:</strong> This tool provides estimates for informational purposes only and does not constitute financial advice. Verify results with the Inland Revenue Department (IRD) of Sri Lanka.</p>
</div>

<div class="copyright-section">
    <div style="display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 5px;">
        <span style="font-size: 13px; color: var(--muted);">&copy;</span>
        <img src="https://raw.githubusercontent.com/tandplive-beep/IIT-Tax-Calculator-Sri-Lanka/refs/heads/main/file_0000000081ac71fa9f5e59de4c9df360%20(1).png" alt="Logo" style="height: 25px; width: auto;">
    </div>
    <p style="font-size: 13px; color: var(--muted); margin: 0;">
	<span style="font-size: 13px; color: var(--muted);">&copy;</span>
        <script>document.write(new Date().getFullYear())</script> <b>TaxWiseSL</b>. All Rights Reserved.
    </p>
    <p style="font-size: 11px; color: var(--muted); opacity: 0.8; margin-top: 5px;">
        TANdplive / TaxWiseSL - Version 2.0
    </p>
</div>

<button class="fab" id="btn_calculate" onclick="calculate()">CALCULATE</button>
</div>

<div class="bottomNav">
    <button onclick="openSummary()"><span id="nav_sum_icon">ЁЯУЛ</span><span id="nav_sum_text">Summary</span></button>
    <button onclick="openHistory()"><span id="nav_his_icon">ЁЯУК</span><span id="nav_his_text">Comparison</span></button>
    <button onclick="downloadPDF()"><span id="nav_pdf_icon">тмЗя╕П</span><span id="nav_pdf_text">PDF</span></button>
    <button onclick="sharePDF()"><span id="nav_sha_icon">ЁЯУд</span><span id="nav_sha_text">Share</span></button>
</div>

<script>
let lastResult = null;
let chart = null;
let historyChart = null;
let historyData = [];

const i18n = {
    en: {
        year: "Tax Year", salary: "Monthly Salary", allowance: "Monthly Allowances", other: "Other Income",
        selfPaid: "Self-Assessed Payments", credits: "Tax Credits", wealth: "Income Distribution", comparison: "Tax Comparison (Last 2 Calculations)",
        calculate: "CALCULATE", summary: "Summary", history: "Comparison", share: "Share", 
        disclaimer: "<strong>Disclaimer:</strong> This tool provides estimates for informational purposes only and does not constitute financial advice. Verify results with the Inland Revenue Department (IRD) of Sri Lanka.",
        taxYear: "Tax Year", netPayable: "Net Tax Payable (Annual)", income: "Income", taxable: "Taxable", monthly: "Monthly", breakdown: "Breakdown",
        takehome: "After-Tax Income", tax: "Tax", 
        compStart: "Perform at least two calculations to see a comparison.", compInc: "Increase", compDec: "Decrease", compOf: "of", compThan: "compared to previous session.",
        refund: "Tax Refund Due", balance: "Balance Tax Payable", liability: "Tax Liability"
    },
    si: {
        year: "р╢╢р╢пр╖Ф р╖Ар╢╗р╖Кр╖Вр╢║", salary: "р╢╕р╖Пр╖Гр╖Тр╢Ъ р╖Ар╖Рр╢зр╖Фр╢┤", allowance: "р╢╕р╖Пр╖Гр╖Тр╢Ъ р╢пр╖Ур╢╕р╢▒р╖П", other: "р╖Ар╖Щр╢▒р╢нр╖К р╢Жр╢пр╖Пр╢║р╢╕р╖К",
        selfPaid: "р╖Гр╖Кр╖Ар╢║р╢В р╢нр╢Ър╖Кр╖Гр╖Ър╢╗р╖Ф р╢Ьр╖Щр╖Ар╖Ур╢╕р╖К", credits: "р╢╢р╢пр╖Ф р╖Гр╖Др╢▒", wealth: "р╢Жр╢пр╖Пр╢║р╢╕р╖К р╖Ар╖КтАНр╢║р╖Пр╢┤р╖Кр╢нр╖Тр╢║", comparison: "р╢╢р╢пр╖Ф р╖Гр╖Рр╖Гр╢│р╖Ур╢╕ (р╢Ер╖Ар╖Гр╖Пр╢▒ р╢Ьр╢лр╢▒р╢║ р╢Ър╖Тр╢╗р╖Ур╢╕р╖К 2)",
        calculate: "р╢Ьр╢лр╢▒р╢║ р╢Ър╢╗р╢▒р╖Кр╢▒", summary: "р╖Гр╖Пр╢╗р╖Пр╢Вр╖Бр╢║", history: "р╖Гр╖Рр╖Гр╢│р╖Ур╢╕", share: "р╢╢р╖Щр╢пр╖Пр╢Ьр╢▒р╖Кр╢▒",
        disclaimer: "<strong>р╖Ар╢Ьр╢Ър╖Ур╢╕р╖К р╢┤р╖КтАНр╢╗р╢Ър╖Пр╖Бр╢║:</strong> р╢╕р╖Щр╢╕ р╢╕р╖Щр╖Ар╢╜р╢╕ р╢нр╖Ьр╢╗р╢нр╖Фр╢╗р╖Ф р╢пр╖Рр╢▒р╢Ьр╖Рр╢▒р╖Ур╢╕ р╖Гр╢│р╖Др╖П р╢┤р╢╕р╢лр╢Ър╖К р╖Ар╢▒ р╢Ер╢нр╢╗ р╢╕р╖Цр╢╜р╖КтАНр╢║ р╢Лр╢┤р╢пр╖Щр╖Гр╖К р╢╜р╢╢р╖П р╢▒р╖Ьр╢пр╖Ъ. р╖Бр╖КтАНр╢╗р╖У р╢╜р╢Вр╢Ър╖П р╢пр╖Ър╖Бр╖Ур╢║ р╢Жр╢пр╖Пр╢║р╢╕р╖К р╢пр╖Щр╢┤р╖Пр╢╗р╖Кр╢нр╢╕р╖Ър╢▒р╖Кр╢нр╖Фр╖А (IRD) р╖Гр╢╕р╢Я р╢┤р╖КтАНр╢╗р╢нр╖Тр╢╡р╢╜ р╢нр╖Др╖Ар╖Фр╢╗р╖Ф р╢Ър╢╗р╢Ьр╢▒р╖Кр╢▒.",
        taxYear: "р╢╢р╢пр╖Ф р╖Ар╢╗р╖Кр╖Вр╢║", netPayable: "р╖Бр╖Фр╢пр╖Кр╢░ р╢╢р╢пр╖Ф р╢╕р╖Фр╢пр╢╜ (р╖Ар╖Пр╢╗р╖Кр╖Вр╖Тр╢Ъ)", income: "р╢Жр╢пр╖Пр╢║р╢╕", taxable: "р╢╢р╢пр╖Ф р╢Ер╢║ р╢Ър╖Е р╖Др╖Рр╢Ър╖Т", monthly: "р╢╕р╖Пр╖Гр╖Тр╢Ъ", breakdown: "р╢╢р╖Тр╢│р╖Ар╖Рр╢зр╖Ур╢╕",
        takehome: "р╢╢р╢пр╖Ф р╢┤р╖Гр╖Ф р╢Жр╢пр╖Пр╢║р╢╕", tax: "р╢╢р╢пр╖Ф",
        compStart: "р╖Гр╖Рр╖Гр╢│р╖Ур╢╕р╢Ър╖К р╢╢р╖Рр╢╜р╖Ур╢╕р╢з р╢Ер╖Ар╢╕ р╖Ар╖Бр╢║р╖Щр╢▒р╖К р╢Ьр╢лр╢▒р╢║ р╢Ър╖Тр╢╗р╖Ур╢╕р╖К р╢пр╖Щр╢Ър╢Ър╖К р╖Гр╖Тр╢пр╖Ф р╢Ър╢╗р╢▒р╖Кр╢▒.", compInc: "р╖Ар╖Рр╢йр╖Тр╖Ар╖Ур╢╕", compDec: "р╢Ер╢йр╖Фр╖Ар╖Ур╢╕", compOf: "", compThan: "р╢┤р╖Щр╢╗ р╖Гр╖Рр╖Гр╖Тр╢║р╢з р╖Гр╖Пр╢┤р╖Ър╢Ър╖Кр╖Вр╖А.",
        refund: "р╢╢р╢пр╖Ф р╢┤р╖КтАНр╢╗р╢нр╖Тр╢┤р╖Цр╢╗р╢лр╢║", balance: "р╢Ьр╖Щр╖Ар╖Тр╢║ р╢║р╖Фр╢нр╖Ф р╖Бр╖Ър╖В р╢╢р╢пр╖Ф", liability: "р╢╢р╢пр╖Ф р╢╢р╖Рр╢│р╖Тр╢║р╖Пр╖А"
    },
    ta: {
        year: "ро╡ро░ро┐ роЖрогрпНроЯрпБ", salary: "рооро╛родро╛роирпНродро┐ро░ роЪроорпНрокро│роорпН", allowance: "рооро╛родро╛роирпНродро┐ро░ роХрпКроЯрпБрокрпНрокройро╡рпБроХро│рпН", other: "роЗродро░ ро╡ро░рпБрооро╛ройроорпН",
        selfPaid: "роЪрпБроп роородро┐рокрпНрокрпАроЯрпНроЯрпБ роХрпКроЯрпБрокрпНрокройро╡рпБроХро│рпН", credits: "ро╡ро░ро┐ ро╡ро░ро╡рпБроХро│рпН", wealth: "ро╡ро░рпБрооро╛рой ро╡ро┐роиро┐ропрпЛроХроорпН", comparison: "ро╡ро░ро┐ роТрокрпНрокрпАроЯрпБ (роХроЯроирпНрод 2 роХрогроХрпНроХрпАроЯрпБроХро│рпН)",
        calculate: "роХрогроХрпНроХро┐роЯрпБроХ", summary: "роЪрпБро░рпБроХрпНроХроорпН", history: "роТрокрпНрокрпАроЯрпБ", share: "рокроХро┐ро░рпН",
        disclaimer: "<strong>рокрпКро▒рпБрокрпНрокрпБродрпН родрпБро▒рокрпНрокрпБ:</strong> роЗроирпНрод роХро░рпБро╡ро┐ родроХро╡ро▓рпН роирпЛроХрпНроХроЩрпНроХро│рпБроХрпНроХро╛роХ роороЯрпНроЯрпБроорпЗ роородро┐рокрпНрокрпАроЯрпБроХро│рпИ ро╡ро┤роЩрпНроХрпБроХро┐ро▒родрпБ рооро▒рпНро▒рпБроорпН роиро┐родро┐ роЖро▓рпЛроЪройрпИропро╛роХ роЕроорпИропро╛родрпБ. роорпБроЯро┐ро╡рпБроХро│рпИ роЗро▓роЩрпНроХрпИропро┐ройрпН роЙро│рпНроиро╛роЯрпНроЯрпБ роЗро▒рпИро╡ро░ро┐родрпН родро┐рогрпИроХрпНроХро│родрпНродрпБроЯройрпН (IRD) роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН.",
        taxYear: "ро╡ро░ро┐ роЖрогрпНроЯрпБ", netPayable: "роиро┐роХро░ ро╡ро░ро┐ роЪрпЖро▓рпБродрпНрод ро╡рпЗрогрпНроЯро┐ропродрпБ (роЖрогрпНроЯрпБ)", income: "ро╡ро░рпБрооро╛ройроорпН", taxable: "ро╡ро░ро┐роХрпНроХрпБро░ро┐ропродрпБ", monthly: "рооро╛родро╛роирпНродро┐ро░", breakdown: "рокроХрпБрокрпНрокро╛ропрпНро╡рпБ",
        takehome: "ро╡ро░ро┐роХрпНроХрпБ рокро┐роирпНродрпИроп ро╡ро░рпБрооро╛ройроорпН", tax: "ро╡ро░ро┐",
        compStart: "роТрокрпНрокрпАроЯрпНроЯрпИрокрпН рокро╛ро░рпНроХрпНроХ роХрпБро▒рпИроирпНродродрпБ роЗро░рогрпНроЯрпБ роХрогроХрпНроХрпАроЯрпБроХро│рпИроЪрпН роЪрпЖропрпНропро╡рпБроорпН.", compInc: "роЕродро┐роХро░ро┐рокрпНрокрпБ", compDec: "роХрпБро▒рпИро╡рпБ", compOf: "", compThan: "роорпБроирпНродрпИроп роЕрооро░рпНро╡рпБроЯройрпН роТрокрпНрокро┐роЯрпБроорпНрокрпЛродрпБ.",
        refund: "ро╡ро░ро┐родрпН родро┐ро░рпБроорпНрокрокрпН рокрпЖро▒рпБродро▓рпН", balance: "роорпАродроорпБро│рпНро│ ро╡ро░ро┐ роЪрпЖро▓рпБродрпНрод ро╡рпЗрогрпНроЯро┐ропродрпБ", liability: "ро╡ро░ро┐ рокрпКро▒рпБрокрпНрокрпБ"
    }
};

function changeLang() {
    const l = i18n[document.getElementById('langSelect').value];
    document.getElementById('lbl_year').innerText = l.year;
    document.getElementById('lbl_salary').innerText = l.salary;
    document.getElementById('lbl_allowance').innerText = l.allowance;
    document.getElementById('lbl_other').innerText = l.other;
    document.getElementById('lbl_selfPaid').innerText = l.selfPaid;
    document.getElementById('lbl_credits').innerText = l.credits;
    document.getElementById('lbl_wealth').innerText = l.wealth;
    document.getElementById('lbl_comparison').innerText = l.comparison;
    document.getElementById('btn_calculate').innerText = l.calculate;
    document.getElementById('nav_sum_text').innerText = l.summary;
    document.getElementById('nav_his_text').innerText = l.history;
    document.getElementById('nav_sha_text').innerText = l.share;
    document.getElementById('disclaimer_box').innerHTML = `<p>${l.disclaimer}</p>`;
    if(lastResult) renderSummary(lastResult);
    if(document.getElementById('historyView').style.display === "block") openHistory();
}

function handleTyping(e) {
    let value = e.target.value.replace(/,/g, '');
    if (!isNaN(value) && value !== "") {
        e.target.value = Number(value).toLocaleString('en-US');
    }
}

function getCurrentTaxYear(){
    const now = new Date();
    let y = now.getFullYear();
    let m = now.getMonth() + 1;
    return (m < 4) ? (y - 1) + "/" + String(y).slice(2) : y + "/" + String(y + 1).slice(2);
}

function populateYears(){
    const current = getCurrentTaxYear();
    const yearEl = document.getElementById('year');
    yearEl.innerHTML = `
        <option>2023/24</option>
        <option>2024/25</option>
        <option selected>${current} (Current Year)</option>
    `;
}

window.onload = () => {
    populateYears();
    if(localStorage.getItem("darkMode") === "on") document.body.classList.add("dark");
};

function toggleDark(){
    document.body.classList.toggle("dark");
    localStorage.setItem("darkMode", document.body.classList.contains("dark") ? "on" : "off");
    
    if(lastResult) {
        drawChart(lastResult.annualIncome, Math.max(0, lastResult.grossTax));
        if(document.getElementById('historyView').style.display === "block") openHistory();
    }
}

function parseNum(id){ 
    let val = document.getElementById(id).value.replace(/,/g, '');
    return Number(val) || 0; 
}

function lkr(v){ return "LKR " + Math.abs(Number(v)).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); }

function getTaxRules(year){
    if(year === "2023/24" || year === "2024/25"){
        return { relief: 1200000, slabs: [500000, 500000, 500000, 500000, 500000], rates: [0.06, 0.12, 0.18, 0.24, 0.30], topRate: 0.36 };
    }
    return { relief: 1800000, slabs: [1000000, 500000, 500000, 500000], rates: [0.06, 0.18, 0.24, 0.30], topRate: 0.36 };
}

function calculate(){
    const selectedYear = document.getElementById('year').value.replace(" (Current Year)", "");
    const salary = parseNum("salary");
    const allowance = parseNum("allowance");
    const other = parseNum("other");
    const selfPaid = parseNum("selfPaid");
    const credits = parseNum("credits");

    const annualIncome = (salary * 12) + (allowance * 12) + other;

    const rules = getTaxRules(selectedYear);
    const taxableIncome = Math.max(0, annualIncome - rules.relief);

    let rem = taxableIncome;
    let tax = 0;
    let breakdown = [];

    for(let i = 0; i < rules.slabs.length && rem > 0; i++){
        let amt = Math.min(rem, rules.slabs[i]);
        let bandTax = amt * rules.rates[i];
        tax += bandTax;
        breakdown.push(`Band ${i+1} (${(rules.rates[i]*100).toFixed(0)}%): ${lkr(bandTax)}`);
        rem -= amt;
    }

    if(rem > 0){
        let extra = rem * rules.topRate;
        tax += extra;
        breakdown.push(`Balance (${(rules.topRate*100).toFixed(0)}%): ${lkr(extra)}`);
    }

    const totalPaid = selfPaid + credits;
    const netTax = tax - totalPaid;
    
    lastResult = {
        year: selectedYear,
        annualIncome, taxableIncome,
        grossTax: tax, netTax, monthlyTax: Math.max(0, netTax) / 12,
        selfPaid, credits, breakdown,
        totalPaid,
        timestamp: new Date().toLocaleTimeString()
    };

    historyData.push(lastResult);
    if(historyData.length > 5) historyData.shift();

    openSummary();
    renderSummary(lastResult);
    document.getElementById('chartCard').style.display = 'block';
    drawChart(annualIncome, Math.max(0, tax));
    
    window.scrollTo({ top: document.getElementById('summaryView').offsetTop - 20, behavior: 'smooth' });
}

function renderSummary(r){
    const l = i18n[document.getElementById('langSelect').value];
    const statusLabel = r.netTax < 0 ? l.refund : l.balance;
    const netValueDisplay = lkr(r.netTax);

    document.getElementById('summaryView').innerHTML = `
    <div class="result">
        <div style="font-size:12px; opacity:0.8; margin-bottom:4px">${l.taxYear}: ${r.year}</div>
        <h1 style="margin:0; font-size:32px">${netValueDisplay}</h1>
        <div style="font-size:14px; opacity:0.9; margin-bottom:16px">${statusLabel} (Annual)</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:12px; border-top:1px solid rgba(255,255,255,0.2); padding-top:15px;">
            <div>${l.liability}: <b>${lkr(r.grossTax)}</b></div>
            <div>${l.income}: <b>${lkr(r.annualIncome)}</b></div>
            <div>${l.taxable}: <b>${lkr(r.taxableIncome)}</b></div>
            <div>${l.monthly}: <b>${lkr(r.monthlyTax)}</b></div>
        </div>
        <div style="margin-top:15px; font-size:11px; background:rgba(0,0,0,0.1); padding:10px; border-radius:10px;">
            <b>${l.breakdown}:</b><br>${r.breakdown.length > 0 ? r.breakdown.join("<br>") : "No Tax Applicable"}
        </div>
    </div>`;
}

function drawChart(income, tax){
    const l = i18n[document.getElementById('langSelect').value];
    const ctx = document.getElementById('taxChart').getContext('2d');
    if(chart) chart.destroy();
    const afterTax = Math.max(0, income - tax);
    
    const isDark = document.body.classList.contains("dark");
    const textColor = isDark ? "#f1f5f9" : "#334155";

    chart = new Chart(ctx, {
        type: "doughnut",
        data: {
            labels: [l.takehome, l.tax],
            datasets: [{
                data: [afterTax, tax],
                backgroundColor: ["#10b981", "#ef4444"],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'bottom', 
                    labels: { 
                        color: textColor, 
                        font: { family: 'Plus Jakarta Sans', weight: '500' } 
                    } 
                }
            },
            cutout: '70%'
        }
    });
}

function openHistory(){ 
    const l = i18n[document.getElementById('langSelect').value];
    document.getElementById('summaryView').style.display = "none";
    document.getElementById('chartCard').style.display = "none";
    document.getElementById('historyView').style.display = "block";

    if(historyData.length < 2) {
        document.getElementById('comparisonText').innerHTML = l.compStart;
        return;
    }

    const latest = historyData[historyData.length - 1];
    const previous = historyData[historyData.length - 2];
    
    const diff = latest.netTax - previous.netTax;
    const percent = previous.netTax !== 0 ? ((diff / previous.netTax) * 100).toFixed(1) : (latest.netTax > 0 ? 100 : 0);
    const color = diff > 0 ? "#ef4444" : "#10b981";
    const status = diff > 0 ? l.compInc : l.compDec;

    document.getElementById('comparisonText').innerHTML = `
        <span style="color:${color}; font-weight:700;">${status} ${l.compOf} ${Math.abs(percent)}%</span> 
        (${lkr(Math.abs(diff))}) ${l.compThan}
    `;

    const hCtx = document.getElementById('historyChart').getContext('2d');
    if(historyChart) historyChart.destroy();

    const isDark = document.body.classList.contains("dark");
    const textColor = isDark ? "#f1f5f9" : "#334155";

    historyChart = new Chart(hCtx, {
        type: 'bar',
        data: {
            labels: [`Prev (${previous.year})`, `Current (${latest.year})`],
            datasets: [{
                label: 'Net Tax (LKR)',
                data: [Math.max(0, previous.netTax), Math.max(0, latest.netTax)],
                backgroundColor: ['#94a3b8', '#2563eb'],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false } 
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' },
                    ticks: { color: textColor }
                },
                x: {
                    ticks: { color: textColor }
                }
            }
        }
    });
}

function openSummary(){ 
    document.getElementById('historyView').style.display = "none";
    document.getElementById('summaryView').style.display = "block";
    document.getElementById('chartCard').style.display = lastResult ? "block" : "none";
}

function generatePDF() {
    if (!lastResult) return null;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const logoUrl = "https://raw.githubusercontent.com/tandplive-beep/IIT-Tax-Calculator-Sri-Lanka/refs/heads/main/file_0000000081ac71fa9f5e59de4c9df360%20(1).png";
    
    // 1. Clean Modern Header (White background with blue accent bar)
    doc.setFillColor(37, 99, 235); 
    doc.rect(0, 0, 5, 297, 'F'); 

    // 2. Logo Placement
    doc.addImage(logoUrl, 'PNG', 15, 15, 80, 30);
    
    // Tagline in PDF
    doc.setTextColor(148, 163, 184);
    doc.setFont("helvetica", "italic");
    doc.setFontSize(9);
    doc.text("Your Taxes, Simplified.", 16, 46);

    // 3. Header Text
    doc.setTextColor(100, 116, 139); 
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text("Individual Income Tax Assessment", 15, 58);
    
    doc.setFont("helvetica", "normal");
    doc.setFontSize(11); 
    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 15, 65);
    doc.text(`Assessment Year: ${lastResult.year}`, 193, 65, { align: "right" });

    // 4. Content Area
    let y = 82;
    doc.setDrawColor(241, 245, 249);
    doc.setLineWidth(0.5);
    doc.line(15, y - 5, 195, y - 5);

    doc.setTextColor(15, 23, 42); 
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("Financial Summary", 15, y);
    y += 10;

    const drawRow = (label, value, isBold = false) => {
        doc.setFont("helvetica", isBold ? "bold" : "normal");
        doc.setFontSize(10);
        doc.setDrawColor(241, 245, 249); 
        doc.line(15, y + 2, 195, y + 2);
        doc.setTextColor(100, 116, 139);
        doc.text(label, 17, y);
        doc.setTextColor(15, 23, 42);
        doc.text(value, 193, y, { align: "right" });
        y += 10;
    };

    const rules = getTaxRules(lastResult.year);

    drawRow("Gross Annual Income", lkr(lastResult.annualIncome));
    drawRow("Personal Tax Relief", "(" + lkr(rules.relief) + ")");
    drawRow("Taxable Income", lkr(lastResult.taxableIncome), true);

    y += 5;
    doc.setFont("helvetica", "bold");
    doc.text("Tax Calculation Breakdown", 15, y);
    y += 10;

    if (lastResult.breakdown.length > 0) {
        lastResult.breakdown.forEach(item => {
            const parts = item.split(": ");
            drawRow(parts[0], parts[1]);
        });
    } else {
        drawRow("Taxable Amount", "Nil");
    }

    y += 5;
    drawRow("Total Tax Liability", lkr(lastResult.grossTax));
    drawRow("Credits & Payments", "(" + lkr(lastResult.totalPaid) + ")");

    // 5. Result Box
    y += 5;
    doc.setFillColor(248, 250, 252);
    doc.roundedRect(15, y, 180, 35, 3, 3, 'F');
    
    const finalLabel = lastResult.netTax < 0 ? "TOTAL TAX REFUND" : "NET TAX PAYABLE";
    
    doc.setTextColor(37, 99, 235);
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.text(finalLabel, 22, y + 12);
    
    doc.setFontSize(22);
    doc.text(lkr(lastResult.netTax), 22, y + 25);
    
    doc.setTextColor(100, 116, 139);
    doc.setFontSize(9);
    doc.setFont("helvetica", "normal");
    doc.text("ESTIMATED MONTHLY", 140, y + 12);
    doc.setFontSize(14);
    doc.setTextColor(15, 23, 42);
    doc.text(lkr(lastResult.monthlyTax), 140, y + 25);

    doc.setFontSize(8);
    doc.setTextColor(148, 163, 184);
    doc.text("This is an electronically generated report. Verify with IRD Sri Lanka for official filing.", 105, 285, {align: "center"});

    doc.saveGraphicsState();
    doc.setGState(new doc.GState({opacity: 0.05}));
    doc.setFontSize(40);
    doc.text("TAXWISE SL VERIFIED", 40, 150, {angle: 45});
    doc.restoreGraphicsState();

    return doc.output("blob");
}

function downloadPDF(){
    if(!lastResult){ alert("Please calculate first"); return; }
    let blob = generatePDF();
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `Tax_Report_${lastResult.year}.pdf`;
    a.click();
}

async function sharePDF(){
    if(!lastResult){ alert("Please calculate first"); return; }
    let blob = generatePDF();
    let file = new File([blob], "TaxReport.pdf", {type: "application/pdf"});
    if(navigator.canShare && navigator.canShare({files: [file]})){
        await navigator.share({files: [file], title: "My Tax Report"});
    } else {
        window.open(URL.createObjectURL(blob));
    }
}
</script>
</body>
</html>
